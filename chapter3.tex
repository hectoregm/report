\chapter{Diseño e implementación del sistema PEAT}

Para lograr los objetivos del sistema \texttt{PEAT} se dividió en cuatro
componentes principales:

\begin{itemize}
\item Perfil sencillo del edificio (\textit{Simple Building Profile}): este
  componente realiza la configuración inicial del edificio, realizando solamente
  un numero limitado de preguntas básicas para definir las características básicas
  del edificio.
\item Perfil detallado del edificio (\textit{Detailed Building Profile}):
  este componente se encarga del manejo de las características básicas, detalladas y
  opcionales de un edificio.
\item Recomendaciones (\textit{Recommendations}): este componente genera una lista
  de medidas de ahorro de energía considerando la información ingresada al sistema
  hasta el momento. Aparte debe permitir al usuario obtener información detallada
  sobre las recomendaciones dadas y finalmente debe permitir indicar que el usuario
  se compromete a llevar acabo una recomendación.
\item Plan de ahorro de energía (\textit{Energy Savings Plan}): este componente
  presenta el consumo de energía del edificio al usuario, también presenta las
  recomendaciones que el usuario se ha comprometido a poner en acción.
\end{itemize}

Como se puede ver el modelo de edificio es el principal modelo dentro de
\texttt{PEAT}, por lo que obtener una correcta correspondencia entre un
edificio y su consumo energético es de vital importancia para dar la
información y recomendaciones mas útiles y fidedignas al usuario.

\section{Modelo de información}

El objetivo principal del modelo de información de \texttt{PEAT} es definir el
modelo de edificio y su relación con el consumo energético del usuario. Así
tenemos el concepto de edificio el cual es una estructura independiente a la
cual se le esta proporcionando un servicio ya sea electricidad o gas.

\subsection{Estructura de facturación de PG\&E}
Para obtener esta correspondencia entre edificio-consumo es necesario
tener en cuenta la estructura de facturación usada por PG\&E puesto
que de esta estructura es que se obtiene el consumo de electricidad y gas.

El usuario, la cuenta y el contrato de servicio representan el lado demográfico
del modelo de información, la cual cambia bastante:

\begin{itemize}
\item Usuario: representa al cliente. Tiene una o más cuentas.
\item Cuenta: representa la contabilidad financiera del usuario. Tiene uno o más
  contratos de servicio, uno por tipo de servicio (electricidad o gas), también
  tiene una o más direcciones de servicio asociadas.
\item Contrato de servicio: representa los servicios que el cliente adquiere
  de PG\&E, como la electricidad o el gas, puede tener uno o más puntos
  de servicio asociados.
\end{itemize}

La dirección de servicio, el punto de servicio y el medidor representan
la parte geográfica del modelo de información, esta información raramente cambia:

\begin{itemize}
\item Dirección de servicio: es una ubicación física en donde se prestan los
  servicios, en \texttt{PEAT} son el modelo que se quiere asociar al modelo
  de edificio para obtener el consumo del edificio, puede tener uno o más puntos
  de servicio.
\item Punto de servicio: es una coordenada geográfica en donde se conectan los
  servicios, puede tener uno o más medidores asociados.
\item Medidor: es un dispositivo instalado en un punto de servicio que registra el
  consumo del servicio proporcionado.
\end{itemize}

La relación entre todos estos modelos se puede ver en la Figura 3.1.

\jcimage{1.0}{imagenes/PGE-facturacion.png}{Modelos principales para la facturación
  en PG\&E.}

\subsection{Relación Edificio-Facturación}

Para que \texttt{PEAT} pueda cumplir sus requerimientos funcionales es necesario
definir claramente la relación entre un edificio y su consumo energético medido
por uno o varios medidores.
Aunque los medidores son los que tienen la información de consumo el relacionar
directamente un medidor con un edificio no es amigable para el usuario, porque
aunque el usuario generalmente conoce el numero de medidores que tiene no conoce
los identificadores para cada uno de estos.

Por lo que para facilitar la creación del perfil de un edificio se pide al usuario
que haga la correspondencia entre las direcciones de servicio asociadas a su cuenta
y el perfil de edificio que se esta creando.
El usuario al dar esta correspondencia permite al sistema obtener de forma
automatizada los puntos de servicio y sus medidores asociados al edificio y así
obtener su consumo energético real.

\section{Casos de uso}

\subsection{Diagrama general}

En la Figura 3.2 se muestra el diagrama general de casos de uso del sistema
\texttt{PEAT}. Se tienen diez casos de uso en total siendo siete casos para
\texttt{PEAT} y tres casos para la biblioteca \texttt{Bezel}.

Los casos de uso se agrupan en los cuatro componentes principales de la
siguiente manera:

\begin{itemize}
\item Perfil sencillo del edificio (\textit{Simple Building Profile}): Tiene
  solo el caso de uso \textit{Crear perfil del edificio} pero este caso de uso
  es uno de los mas complejos en cuestión de interacción con el usuario y su
  importancia para obtener las características básicas del edificio.
\item Perfil detallado del edificio (\textit{Detailed Building Profile}): Contiene
  los casos de uso \textit{Administrar perfil del edificio} y
  \textit{Obtener información del edificio} los cuales se encargan de la
  administración y obtención de información sobre el edificio.
\item Recomendaciones (\textit{Recommendations}): Contiene los casos de uso
  \textit{Administrar recomendaciones} y \textit{Ver recomendación}.
\item Plan de ahorro de energía (\textit{Energy Savings Plan}): Contiene los
  casos de uso \textit{Ver historial de consumo} y \textit{Administrar plan de
    ahorro}
  que se enfocan a la visualización del consumo eléctrico del usuario y las
  posibles recomendaciones para disminuir su consumo.
\end{itemize}

\jcimageinline{1.0}{imagenes/Diagrama-General-CasosDeUso.png}{Diagrama general de
  casos de uso de \texttt{PEAT}.}

\subsection{Crear perfil del edificio}

Para crear el perfil inicial de un edificio es necesario obtener las siguientes
características:

\begin{itemize}
\item La industria que mejor describe el negocio del usuario.
\item El tamaño del edificio (área).
\item El tipo de edificio.
\item La(s) dirección(es) de servicio asociada(s) al edificio.
\end{itemize}

Todas estas características se consideran básicas, es decir vitales para el
funcionamiento del sistema por lo todas son requeridas para construir el perfil
del edificio.

En este caso de uso también se obtiene la relación entre el edificio y su consumo
a partir de las direcciones de servicio que el usuario asocie al perfil.

El caso de uso esta diseñado de forma que el proceso sea realizado solamente
una vez por edificio. Las características básicas se mantienen accesibles por
medio del perfil detallado del edificio.

\begin{usecase}
  \addtitle{Caso de Uso:}{Crear perfil del edificio.}
  \addfield{Descripción:}{Un usuario PyME entra al sistema  para crear un perfil
    inicial de un edificio, respondiendo ciertas preguntas básicas sobre el
    edificio.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item Los datos de intervalo y de facturación del usuario están en el sistema.
  }
  \additemizedfield{Requerimientos no funcionales:}{
  \item El usuario debe ser capaz de completar el perfil del edificio en 20 segundos
    o menos.
  }
  \addscenario{Flujo normal:}{
  \item El sistema checa si el usuario tiene mas de una cuenta.
    \begin{enumerate}
    \item Si hay mas de una cuenta el sistema despliega una lista
      de cuentas, y el sistema requiere que el usuario elija una cuenta.
    \end{enumerate}
  \item El sistema despliega información sobre la cuenta: numero de cuenta y
    direcciones de servicio asociadas.
    \begin{enumerate}
    \item Si la cuenta tiene mas de una dirección de servicio
      el sistema requiere que el usuario elija por lo menos una dirección
      de servicio.
    \end{enumerate}
  \item El usuario selecciona las direcciones de servicio que apliquen
    al edificio.
  \item El usuario puede proporcionar un apodo para el edificio.
  \item El usuario debe indicar la industria que mejor describe su negocio.
  \item El usuario debe ingresar la siguiente información sobre el edificio:
    \begin{enumerate}
    \item Tipo.
    \item Rango de tamaño.
    \item Antigüedad.
    \end{enumerate}
  \item El usuario puede enviar los datos ingresados o cancelar.
  \item El usuario puede añadir otro edificio o si ya tiene al menos un
    perfil de edificio asociado puede proceder al plan de ahorro.
  }
  \addfield{Postcondiciones:}{
    Se genera un identificador único para el perfil del edificio generado, el cual
    esta asociado a los datos de facturación de la cuenta seleccionada por el
    usuario PyME.
  }
\end{usecase}

% FIXME: Insertar diagrama del modelo de información inducido por la creación
% de un perfil

\subsection{Administrar perfil del edificio}

Para el sistema \texttt{PEAT} se tiene las siguientes características:
\begin{itemize}
\item Básicas: son las características básicas de un edificio: tipo, tamaño y
  antigüedad, son vitales para el funcionamiento del sistema.
\item Detalladas: son las características mas significativas y fáciles de
  responder, ejemplos son: horas de operación, numero de empleados, numero
  de pisos, etcétera.
\item Opcionales: son características más avanzadas/técnicas sobre el equipo
  y estructura de un edificio.
\end{itemize}

Las características básicas son definidas al crear el perfil inicial de un
edificio como se documenta en el caso de uso anterior. Las características
detalladas y opcionales son definidas por medio de dos rutas:

\begin{itemize}
\item Por medio del perfil detallado del edificio, en la que se despliega
  las preguntas y respuestas sobre las características del edificio.
  Esta ruta es documentada en este caso de uso.
\item Un componente que es embebido en varias partes del sistema
  que realiza una sola pregunta al usuario para ir obteniendo progresivamente
  mas información sobre el edificio. Este componente tiene el nombre
  de Componente de Ingreso Progresivo (\textit{Progressive Profile Widget} PPW).
  Esta ruta es documentada en el caso de uso \textit{Obtener información
    del edificio}
\end{itemize}

\begin{usecase}
  \addtitle{Caso de Uso:}{Administrar perfil del edificio.}
  \addfield{Descripción:}{
    El usuario tiene acceso al perfil completo del edificio, es decir
    a todas las preguntas y respuestas asociadas a las características
    básicas, detalladas y opcionales de un edificio.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \additemizedfield{Requerimientos no funcionales:}{
  \item Todas las acciones realizadas por el usuario deben ser procesadas
    en menos de un segundo.
  }
  \addscenario{Flujo normal:}{
  \item El sistema checa si la cuenta tiene mas de un edificio asociado.
    \begin{itemize}
    \item Si hay mas de un edificio asociado a la cuenta el usuario
      tiene que seleccionar el edificio correspondiente.
    \end{itemize}
  \item El sistema despliega una lista de preguntas y respuestas divida en secciones.
    Las secciones completadas están marcadas con una marca de completado.
    \begin{itemize}
    \item Las secciones que se despliegan dependen del tipo de edificio,
      por ejemplo: construcción, iluminación, calefacción y refrigeración.
    \item El usuario puede ver y actualizar sus respuestas a todas las
      preguntas en una sola pantalla.
    \end{itemize}
  \item El usuario selecciona una sección, esta se expande para mostrar todas
    las preguntas de la sección.
  \item El usuario responde una o varias preguntas.
    \begin{enumerate}
    \item Las preguntas son ordenadas dentro de cada sección según un orden
      predefinido. Las secciones también tienen un orden predefinido.
    \item Según vaya respondiendo el usuario se va actualizando un indicador
      del progreso de llenado del perfil. Cada pregunta/respuesta tiene el
      mismo valor para calcular el progreso de llenado.
    \end{enumerate}
  \item El usuario puede elegir continuar con la siguiente sección o dar click
    en el encabezado de otra sección.
  \item El sistema salva la información en cuanto el usuario selecciona
    una respuesta. Al obtener nueva información el sistema debe recalcular
    las recomendaciones asociadas al edificio.
  }
  \additemizedfield{Postcondiciones:}{
  \item Un perfil del edificio mas detallado si el usuario dio respuesta a una
    pregunta sin contestar sobre su edificio.
  \item Si el usuario dio nueva información se recalculan las recomendaciones
    asociadas al edificio.
  }
\end{usecase}

\subsection{Obtener información del edificio}

Uno de los requerimientos mas importante para \texttt{PEAT} es el incentivar y
obtener mas información sobre las características de los edificios del usuario.
Esto es porque entre mas información se obtiene de estos se pueden generar
mejores planes de ahorro y recomendaciones para el usuario.

La forma en como se aborda esta necesidad es por medio de la implementación
de un componente que esta presente en las dos partes principales del sistema:
el plan de ahorro y la lista de recomendaciones. Este componente tiene el
nombre de Componente de Ingreso Progresivo de Información (\textit{Progressive
  Profile Widget} PPW). Este componente realiza una sola pregunta al usuario
obteniendo progresivamente mas información sobre el edificio.

\begin{usecase}
  \addtitle{Caso de Uso:}{Obtener información del edificio.}
  \addfield{Descripción:}{El sistema va obteniendo información
    progresivamente del usuario haciendo uso de un componente que
    realiza una pregunta al usuario en varias partes del sistema.
    Este componente tiene el nombre de Componente de Ingreso Progresivo de
    Información (\textit{Progressive Profile Widget} PPW).}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \additemizedfield{Requerimientos no funcionales:}{
  \item Las actualizaciones a la pagina deben hacerse en forma
    asíncrona y sin necesitar una recarga completa de la pagina.
  }
  \addscenario{Flujo normal:}{
  \item El sistema despliega el componente PPW en la parte izquierda en las
    pantallas de plan de ahorro y de recomendaciones.
  \item Dentro del PPW, se presenta al usuario una pregunta a responder
    \begin{enumerate}
    \item Dependiendo de la pregunta, el usuario puede seleccionar una
      respuesta de una lista desplegable, seleccionar casillas,
      responder Si o No con un botón radial o ingresar un valor
      en un campo.
    \item Cada tipo de edificio tiene una lista predefinida ordenada de
      preguntas a ser desplegadas en el componente.
    \item Algunas preguntas tienen imágenes asociadas para facilitar
      al usuario su respuesta.
    \end{enumerate}
  \item El usuario puede o bien responder la pregunta, saltar la pregunta o
    no hacer nada en el PPW.
    \begin{enumerate}
    \item Si el usuario responde:
      \begin{enumerate}
      \item La respuesta provoca un refinamiento del perfil del edificio y
        el nuevo calculo de las recomendaciones propuestas.
        \begin{enumerate}[i.]
        \item El perfil del edificio es actualizado, las recomendaciones
          son recalculadas.
        \item El sistema despliega un indicador de progreso mientras
          se recalculan las recomendaciones.
        \item Al finalizar el refinamiento el orden de las preguntas
          o los valores del plan de ahorro deben ser actualizados, esto
          debe hacerse sin necesitar una recarga completa de la pagina.
        \end{enumerate}
      \item El sistema despliega la siguiente pregunta.
      \item El sistema persiste la respuesta dada.
      \end{enumerate}
    \item Si el usuario elige saltar la pregunta entonces el sistema
      despliega la siguiente pregunta sin necesitar de una respuesta por el usuario.
    \end{enumerate}
  \item Desde el PPW, el usuario puede dar click a ''Building Profile''\ para ver
    el perfil detallado del edificio.
  }
  \additemizedfield{Postcondiciones:}{
  \item Un perfil del edificio mas detallado si el usuario dio respuesta a la
    pregunta desplegada sobre su edificio.
  \item Si el usuario dio nueva información se recalculan las recomendaciones
    asociadas al edificio.
  }
\end{usecase}

\subsection{Administrar recomendaciones}

En los casos de uso anteriores se obtiene del usuario el perfil del edificio
y por lo menos sus características básicas. Haciendo uso de esta información
el sistema \texttt{PEAT} genera recomendaciones sobre como disminuir el consumo
de energía a través de cambios de comportamiento y/o modernización de equipo.

Las recomendaciones se muestran en tres partes del sistema:
\begin{enumerate}
\item En el plan de ahorro.
\item En las recomendaciones.
\item En el perfil detallado del edificio.
\end{enumerate}

\begin{usecase}
  \addtitle{Caso de Uso:}{Administrar recomendaciones.}
  \addfield{Descripción:}{El sistema despliega una lista de todas las
    recomendaciones que se ajustan al perfil del edificio del usuario.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \additemizedfield{Requerimientos no funcionales:}{
  \item
  }
  \addscenario{Flujo normal:}{
  \item El sistema despliega las recomendaciones, ya sea en el plan
    de ahorro, la lista de recomendaciones o en el perfil detallado del edificio.
  \item El usuario puede tomar las siguientes acciones:
    \begin{itemize}
    \item Añadir al plan (de ahorro).
      \begin{enumerate}
      \item Cuando el usuario da click a ''Añadir al plan'', una ventana modal
        se abre y pregunta: ''¿ Cuando piensa completar esta acción ?''.
      \item El sistema proporciona lista predefinida de rangos de tiempo:
        una semana, un mes, tres meses, etcétera.
      \item El usuario elige el rango de tiempo adecuado y da click
        a ''Add to plan''
      \item El sistema añade la recomendación al plan de ahorro del edificio.
      \end{enumerate}
    \item No aplica.
      \begin{enumerate}
      \item El sistema mueve la recomendación al final de la lista de
        recomendaciones.
      \item En cualquier momento, el usuario puede cambiar el estado de la
        recomendación, es decir añadir la recomendación al plan de ahorro
        o indicar que no es aplicable al edificio.
      \end{enumerate}
    \item Ya completado.
      \begin{enumerate}
      \item El sistema mueve la recomendación al final de la lista de
        recomendaciones.
      \item En cualquier momento, el usuario puede cambiar el estado de la
        recomendación, es decir añadir la recomendación al plan de ahorro
        o indicar que no es aplicable al edificio.
      \end{enumerate}
    \end{itemize}

  \item El sistema refina y reordena la lista de recomendaciones después de que
    el usuario realiza cualquiera de las acciones anteriores.
  }
  \Addfield{Postcondiciones:}{
  }
\end{usecase}

\section{Interfase de usuario}

Dentro de los requerimientos de \texttt{PEAT} se tenia la implementación de una
interfaz de usuario que fuera lo suficientemente eficaz y sencilla, para así obtener
la mayor cantidad de información del usuario.

\subsection{Crear perfil del edificio}
