\chapter{Diseño e implementación del sistema PEAT}

Para lograr los objetivos del sistema \texttt{PEAT} se dividió en cuatro
componentes principales:

\begin{itemize}
\item Perfil sencillo del edificio (\textit{Simple Building Profile}): este
  componente realiza la configuración inicial del edificio, realizando solamente
  un numero limitado de preguntas básicas para definir las características básicas
  del edificio.
\item Perfil detallado del edificio (\textit{Detailed Building Profile}):
  este componente se encarga del manejo de las características básicas, detalladas y
  opcionales de un edificio.
\item Recomendaciones (\textit{Recommendations}): este componente genera una lista
  de medidas de ahorro de energía considerando la información ingresada al sistema
  hasta el momento. Además debe permitir al usuario obtener información detallada
  sobre las recomendaciones dadas y permitir que el usuario se comprometa a
  llevar acabo una recomendación.
\item Plan de ahorro de energía (\textit{Energy Savings Plan}): este componente
  presenta el consumo de energía del edificio al usuario, también presenta las
  recomendaciones que el usuario se ha comprometido a poner en acción y el
  ahorro que representa llevar acabo estas medidas.
\end{itemize}

El  modelo de edificio es el principal modelo dentro de \texttt{PEAT}, por lo que
obtener una correcta correspondencia entre un edificio y su consumo energético
es de vital importancia para dar la información y recomendaciones mas útiles y
fidedignas al usuario.

\section{Modelo de información}

El objetivo principal del modelo de información de \texttt{PEAT} es definir el
modelo de edificio y su relación con el consumo energético del usuario. Así
tenemos el concepto de edificio el cual es una estructura independiente a la
cual se le esta proporcionando un servicio ya sea electricidad o gas.

\subsection{Estructura de facturación de PG\&E}
Para obtener esta correspondencia entre edificio-consumo es necesario
tener en cuenta la estructura de facturación usada por PG\&E puesto
que de esta estructura es que se obtiene el consumo de electricidad y gas.

Los modelos se pueden categorizar en dos grupos: demográficos o geográficos.

El usuario, la cuenta y el contrato de servicio representan el lado demográfico
del modelo de información, la cual cambia bastante:

\begin{itemize}
\item Usuario: representa al empresario. Tiene una o más cuentas.
\item Cuenta: representa la contabilidad financiera del usuario. Tiene uno o más
  contratos de servicio, uno por tipo de servicio (electricidad o gas), también
S  tiene una o más direcciones de servicio asociadas.
\item Contrato de servicio: representa los servicios que el cliente adquiere
  de PG\&E, como la electricidad o el gas, puede tener uno o más puntos
  de servicio asociados.
\end{itemize}

La dirección de servicio, el punto de servicio y el medidor representan
la parte geográfica del modelo de información, esta información raramente cambia:

\begin{itemize}
\item Dirección de servicio: es una ubicación física en donde se prestan los
  servicios, en \texttt{PEAT} son el modelo que se quiere asociar al modelo
  de edificio para obtener el consumo del edificio, puede tener uno o más puntos
  de servicio.
\item Punto de servicio: es una coordenada geográfica en donde se conectan los
  servicios, puede tener uno o más medidores asociados.
\item Medidor: es un dispositivo instalado en un punto de servicio que registra el
  consumo del servicio proporcionado.
\end{itemize}

La relación entre todos estos modelos se puede ver en la Figura 3.1.

\jcimage{1.0}{imagenes/PGE-facturacion.png}{Modelos principales para la facturación
  en PG\&E.}

\subsection{Relación Edificio-Facturación}

Para que \texttt{PEAT} pueda cumplir sus requerimientos funcionales es necesario
definir claramente la relación entre un edificio y su consumo energético medido
por uno o varios medidores.
Aunque los medidores son los que tienen la información de consumo el relacionar
directamente un medidor con un edificio no es amigable para el usuario, porque
aunque el usuario generalmente conoce el numero de medidores que tiene no conoce
los identificadores para cada uno de estos.

Por lo que para facilitar la creación del perfil de un edificio se pide al usuario
que haga la correspondencia entre las direcciones de servicio asociadas a su cuenta
y el perfil de edificio que se esta creando.
El usuario al dar esta correspondencia permite al sistema obtener de forma
automatizada los puntos de servicio y sus medidores asociados al edificio y así
obtener su consumo energético real.

\section{Casos de uso}

\subsection{Diagrama general}

En la Figura 3.2 se muestra el diagrama general de casos de uso del sistema
\texttt{PEAT}. Se tienen diez casos de uso en total siendo siete casos para
\texttt{PEAT} y tres casos para la biblioteca \texttt{Bezel}.

Los casos de uso se agrupan en los cuatro componentes principales de la
siguiente manera:

\begin{itemize}
\item Perfil sencillo del edificio (\textit{Simple Building Profile}): Tiene
  solo el caso de uso \textit{Crear perfil del edificio} pero este caso de uso
  es uno de los mas complejos en cuestión de interacción con el usuario y su
  importancia para obtener las características básicas del edificio.
\item Perfil detallado del edificio (\textit{Detailed Building Profile}): Contiene
  los casos de uso \textit{Administrar perfil del edificio} y
  \textit{Obtener información del edificio} los cuales se encargan de la
  administración y obtención de información sobre el edificio.
\item Recomendaciones (\textit{Recommendations}): Contiene los casos de uso
  \textit{Administrar recomendaciones} y \textit{Ver recomendación}.
\item Plan de ahorro de energía (\textit{Energy Savings Plan}): Contiene los
  casos de uso \textit{Ver historial de consumo} y \textit{Administrar plan de
    ahorro}
  que se enfocan a la visualización del consumo eléctrico del usuario y las
  posibles recomendaciones para disminuir su consumo.
\end{itemize}

\jcimageinline{1.0}{imagenes/Diagrama-General-CasosDeUso.png}{Diagrama general de
  casos de uso de \texttt{PEAT}.}

\subsection{Crear perfil del edificio}

Para crear el perfil inicial de un edificio es necesario obtener las siguientes
características:

\begin{itemize}
\item La industria que mejor describe el negocio del usuario.
\item El tamaño del edificio (área).
\item El tipo de edificio.
\item La(s) dirección(es) de servicio asociada(s) al edificio.
\end{itemize}

Todas estas características se consideran básicas, es decir vitales para el
funcionamiento del sistema por lo todas son requeridas para construir el perfil
del edificio.

En este caso de uso también se obtiene la relación entre el edificio y su consumo
a partir de las direcciones de servicio que el usuario asocie al perfil.

El caso de uso esta diseñado de forma que el proceso sea realizado solamente
una vez por edificio. Las características básicas se mantienen accesibles por
medio del perfil detallado del edificio.

\begin{usecase}
  \addtitle{Caso de Uso:}{Crear perfil del edificio.}
  \addfield{Descripción:}{Un usuario PyME entra al sistema  para crear un perfil
    inicial de un edificio, respondiendo ciertas preguntas básicas sobre el
    edificio.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item Los datos de intervalo y de facturación del usuario están en el sistema.
  }
  \additemizedfield{Requerimientos no funcionales:}{
  \item El usuario debe ser capaz de completar el perfil del edificio en 20 segundos
    o menos.
  }
  \addscenario{Flujo normal:}{
  \item El sistema checa si el usuario tiene mas de una cuenta.
    \begin{enumerate}
    \item Si hay mas de una cuenta el sistema despliega una lista
      de cuentas, y el sistema requiere que el usuario elija una cuenta.
    \end{enumerate}
  \item El sistema despliega información sobre la cuenta: numero de cuenta y
    direcciones de servicio asociadas.
    \begin{enumerate}
    \item Si la cuenta tiene mas de una dirección de servicio
      el sistema requiere que el usuario elija por lo menos una dirección
      de servicio.
    \end{enumerate}
  \item El usuario selecciona las direcciones de servicio que apliquen
    al edificio.
  \item El usuario puede proporcionar un apodo para el edificio.
  \item El usuario debe indicar la industria que mejor describe su negocio.
  \item El usuario debe ingresar la siguiente información sobre el edificio:
    \begin{enumerate}
    \item Tipo.
    \item Rango de tamaño.
    \item Antigüedad.
    \end{enumerate}
  \item El usuario puede enviar los datos ingresados o cancelar.
  \item El usuario puede añadir otro edificio o si ya tiene al menos un
    perfil de edificio asociado puede proceder al plan de ahorro.
  }
  \addfield{Postcondiciones:}{
    Se genera un identificador único para el perfil del edificio generado, el cual
    esta asociado a los datos de facturación de la cuenta seleccionada por el
    usuario PyME.
  }
\end{usecase}

% FIXME: Insertar diagrama del modelo de información inducido por la creación
% de un perfil

\subsection{Administrar perfil del edificio}

Para el sistema \texttt{PEAT} se tiene las siguientes características:
\begin{itemize}
\item Básicas: son las características básicas de un edificio: tipo, tamaño y
  antigüedad, son vitales para el funcionamiento del sistema.
\item Detalladas: son las características mas significativas y fáciles de
  responder, ejemplos son: horas de operación, numero de empleados, numero
  de pisos, etcétera.
\item Opcionales: son características más avanzadas/técnicas sobre el equipo
  y estructura de un edificio.
\end{itemize}

Las características básicas son definidas al crear el perfil inicial de un
edificio como se documenta en el caso de uso anterior. Las características
detalladas y opcionales son definidas por medio de dos rutas:

\begin{itemize}
\item Por medio del perfil detallado del edificio, en la que se despliega
  las preguntas y respuestas sobre las características del edificio.
  Esta ruta es documentada en este caso de uso.
\item Un componente que es embebido en varias partes del sistema
  que realiza una sola pregunta al usuario para ir obteniendo progresivamente
  mas información sobre el edificio. Este componente llamado componente
  de ingreso progresivo (\textit{Progressive Profile Widget} PPW).
  Esta ruta es documentada en el caso de uso \textit{Obtener información
    del edificio}
\end{itemize}

\begin{usecase}
  \addtitle{Caso de Uso:}{Administrar perfil del edificio.}
  \addfield{Descripción:}{
    El usuario tiene acceso al perfil completo del edificio, es decir
    a todas las preguntas y respuestas asociadas a las características
    básicas, detalladas y opcionales de un edificio.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \additemizedfield{Requerimientos no funcionales:}{
  \item Todas las acciones realizadas por el usuario deben ser procesadas
    en menos de un segundo.
  }
  \addscenario{Flujo normal:}{
  \item El sistema checa si la cuenta tiene mas de un edificio asociado.
    \begin{itemize}
    \item Si hay mas de un edificio asociado a la cuenta el usuario
      tiene que seleccionar el edificio correspondiente.
    \end{itemize}
  \item El sistema despliega una lista de preguntas y respuestas divida en secciones.
    Las secciones completadas están marcadas con una marca de completado.
    \begin{itemize}
    \item Las secciones que se despliegan dependen del tipo de edificio,
      por ejemplo: construcción, iluminación, calefacción y refrigeración.
    \item El usuario puede ver y actualizar sus respuestas a todas las
      preguntas en una sola pantalla.
    \end{itemize}
  \item El usuario selecciona una sección, esta se expande para mostrar todas
    las preguntas de la sección.
  \item El usuario responde una o varias preguntas.
    \begin{enumerate}
    \item Las preguntas son ordenadas dentro de cada sección según un orden
      predefinido. Las secciones también tienen un orden predefinido.
    \item Según vaya respondiendo el usuario se va actualizando un indicador
      del progreso de llenado del perfil. Cada pregunta/respuesta tiene el
      mismo valor para calcular el progreso de llenado.
    \end{enumerate}
  \item El usuario puede elegir continuar con la siguiente sección o dar click
    en el encabezado de otra sección.
  \item El sistema salva la información en cuanto el usuario selecciona
    una respuesta. Al obtener nueva información el sistema debe recalcular
    las recomendaciones asociadas al edificio.
  }
  \additemizedfield{Postcondiciones:}{
  \item Un perfil del edificio mas detallado si el usuario dio respuesta a una
    pregunta sin contestar sobre su edificio.
  \item Si el usuario dio nueva información se recalculan las recomendaciones
    asociadas al edificio.
  }
\end{usecase}

\subsection{Obtener información del edificio}

Uno de los requerimientos mas importante para \texttt{PEAT} es el incentivar y
obtener mas información sobre las características de los edificios del usuario.
Esto es porque entre mas información se obtiene de estos se pueden generar
mejores planes de ahorro y recomendaciones para el usuario.

La forma en como se aborda esta necesidad es por medio de la implementación
de un componente que esta presente en las dos partes principales del sistema:
el plan de ahorro y la lista de recomendaciones. Este componente llamado
componente de ingreso progresivo (\textit{Progressive Profile Widget} PPW).
Este componente realiza una sola pregunta al usuario obteniendo progresivamente
mas información sobre el edificio.

\begin{usecase}
  \addtitle{Caso de Uso:}{Obtener información del edificio.}
  \addfield{Descripción:}{El sistema va obteniendo información
    progresivamente del usuario haciendo uso de un componente que
    realiza una pregunta al usuario en varias partes del sistema.
    Este componente se llama componente de ingreso progresivo (\textit{Progressive
      Profile Widget} PPW).}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \addfield{Requerimientos no funcionales:}{
    Las actualizaciones a la pagina deben hacerse en forma
    asíncrona y sin necesitar una recarga completa de la pagina.
  }
  \addscenario{Flujo normal:}{
  \item El sistema despliega el componente PPW en la parte izquierda en las
    pantallas de plan de ahorro y de recomendaciones.
  \item Dentro del PPW, se presenta al usuario una pregunta a responder
    \begin{enumerate}
    \item Dependiendo de la pregunta, el usuario puede seleccionar una
      respuesta de una lista desplegable, seleccionar casillas,
      responder Si o No con un botón radial o ingresar un valor
      en un campo.
    \item Cada tipo de edificio tiene una lista predefinida ordenada de
      preguntas a ser desplegadas en el componente.
    \item Algunas preguntas tienen imágenes asociadas para facilitar
      al usuario su respuesta.
    \end{enumerate}
  \item El usuario puede o bien responder la pregunta, saltar la pregunta o
    no hacer nada en el PPW.
    \begin{enumerate}
    \item Si el usuario responde:
      \begin{enumerate}
      \item La respuesta provoca un refinamiento del perfil del edificio y
        el nuevo calculo de las recomendaciones propuestas.
        \begin{enumerate}[i.]
        \item El perfil del edificio es actualizado, las recomendaciones
          son recalculadas.
        \item El sistema despliega un indicador de progreso mientras
          se recalculan las recomendaciones.
        \item Al finalizar el refinamiento el orden de las preguntas
          o los valores del plan de ahorro deben ser actualizados, esto
          debe hacerse sin necesitar una recarga completa de la pagina.
        \end{enumerate}
      \item El sistema despliega la siguiente pregunta.
      \item El sistema persiste la respuesta dada.
      \end{enumerate}
    \item Si el usuario elige saltar la pregunta entonces el sistema
      despliega la siguiente pregunta sin necesitar de una respuesta por el usuario.
    \end{enumerate}
  \item Desde el PPW, el usuario puede dar click a ''Building Profile''\ para ver
    el perfil detallado del edificio.
  }
  \additemizedfield{Postcondiciones:}{
  \item Un perfil del edificio mas detallado si el usuario dio respuesta a la
    pregunta desplegada sobre su edificio.
  \item Si el usuario dio nueva información se recalculan las recomendaciones
    asociadas al edificio.
  }
\end{usecase}

\subsection{Administrar recomendaciones}

En los casos de uso anteriores se obtiene del usuario el perfil del edificio
y por lo menos sus características básicas. Haciendo uso de esta información
el sistema \texttt{PEAT} genera recomendaciones sobre como disminuir el consumo
de energía a través de cambios de comportamiento y/o modernización de equipo.

Las recomendaciones se muestran en tres partes del sistema:
\begin{enumerate}
\item En el plan de ahorro.
\item En las recomendaciones.
\item En el perfil detallado del edificio.
\end{enumerate}

\begin{usecase}
  \addtitle{Caso de Uso:}{Administrar recomendaciones.}
  \addfield{Descripción:}{El sistema despliega una lista de todas las
    recomendaciones que se ajustan al perfil del edificio.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \additemizedfield{Requerimientos no funcionales:}{
  \item Cualquier acción en una recomendación debe hacerse en forma
    asíncrona y sin necesitar una recarga completa de la pagina.
  }
  \addscenario{Flujo normal:}{
  \item El sistema despliega las recomendaciones, ya sea en el plan
    de ahorro, la lista de recomendaciones o en el perfil detallado del edificio.
  \item El usuario puede tomar las siguientes acciones:
    \begin{itemize}
    \item Añadir al plan (de ahorro).
      \begin{enumerate}
      \item Cuando el usuario da click a ''Añadir al plan'', una ventana modal
        se abre y pregunta: ''¿ Cuando piensa completar esta acción ?''.
      \item El sistema proporciona lista predefinida de rangos de tiempo:
        una semana, un mes, tres meses, etcétera.
      \item El usuario elige el rango de tiempo adecuado y da click
        a ''Add to plan''
      \item El sistema añade la recomendación al plan de ahorro del edificio.
      \end{enumerate}
    \item No aplica.
      \begin{enumerate}
      \item El sistema mueve la recomendación al final de la lista de
        recomendaciones.
      \item En cualquier momento, el usuario puede cambiar el estado de la
        recomendación, es decir añadir la recomendación al plan de ahorro
        o indicar que no es aplicable al edificio.
      \end{enumerate}
    \item Ya completado.
      \begin{enumerate}
      \item El sistema mueve la recomendación al final de la lista de
        recomendaciones.
      \item En cualquier momento, el usuario puede cambiar el estado de la
        recomendación, es decir añadir la recomendación al plan de ahorro
        o indicar que no es aplicable al edificio.
      \end{enumerate}
    \end{itemize}
  \item El sistema refina y reordena la lista de recomendaciones después de que
    el usuario realiza cualquiera de las acciones anteriores.
  }
  \addscenario{Flujo alternativo:}{
  \item El usuario contesta alguna pregunta en el PPW o en el perfil detallado del
    edificio.
  \item El sistema refina y reordena la lista de recomendaciones después de que
    el usuario realiza cualquiera de las acciones anteriores.
  }
  \additemizedfield{Postcondiciones:}{
  \item Si el usuario añadió una recomendación a su plan de ahorro entonces
    se tiene un plan de ahorro actualizado.
  \item Si el usuario realizo cualquier acción en una recomendación entonces
    la lista de recomendaciones es actualizada y reordenada.
  }
\end{usecase}

\subsection{Ver recomendación}

En el plan de ahorro, la lista de recomendaciones o en el perfil detallado
del edificio solo se despliega el titulo y descripción breve de cada
recomendación. Entonces es necesario proporcionar al usuario mas información
detallada sobre la recomendación que el usuario quiere implementar.

\begin{usecase}
  \addtitle{Caso de Uso:}{Ver recomendación}
  \addfield{Descripción:}{El sistema despliega información adicional
    sobre una recomendación para que el usuario pueda elegir
    implementarla.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \addfield{Requerimientos no funcionales:}{
    Cualquier acción en una recomendación debe hacerse en forma
    asíncrona y sin necesitar una recarga completa de la pagina.
  }
  \addscenario{Flujo normal:}{
  \item El usuario ve una recomendación que capta su atención y da un
    click en el titulo de la recomendación.
  \item El sistema despliega información adicional sobre la recomendación, por
    ejemplo cuanto ahorro daría realizar la recomendación, que se necesita
    hacer para obtener este ahorro, etcétera.
  \item El usuario puede realizar las acciones definidas en el caso
    de uso anterior es decir, añadir la recomendación al plan de ahorro
    indicar que no aplica o indicar que ya ha sido completada la recomendación.
  }
  \addfield{Postcondiciones:}{
    Si el usuario realizo cualquier acción en una recomendación entonces
    la lista de recomendaciones es actualizada y reordenada.
  }
\end{usecase}

\subsection{Ver historial de consumo}

\begin{usecase}
  \addtitle{Caso de Uso:}{Ver historial de consumo}
  \addfield{Descripción:}{Se muestra el consumo energético del edificio
    mediante un conjunto de gráficas con múltiples vistas para diferentes
    rangos de tiempo, categorías rangos de tiempo y categorías.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \addfield{Requerimientos no funcionales:}{
    Las actualizaciones a la pagina deben hacerse en forma asíncrona y sin necesitar
    una recarga completa de la pagina.
  }
  \addscenario{Flujo normal:}{
  \item El sistema despliega inicialmente una gráfica del gasto anual de
    electricidad y gas del edificio.
  \item El sistema muestra un menú con las siguientes opciones de visualización:
    \begin{itemize}
    \item Gasto: Medido en dolares con gráficas anuales, mensuales y diarias.
    \item Electricidad: Medido en kilowatt-hora con gráficas anuales, mensuales y
      diarias.
    \item Gas: Medido en termia, con gráficas anuales, mensuales y diarias
    \item Emisiones de carbón: Medido en toneladas, con gráficas anuales, mensuales
      y diarias.
    \item Análisis: Gráfica que indica el consumo estimado según la categoría.
      Las categorías son por ejemplo: refrigeración, iluminación, calefacción,
      etcétera.
    \end{itemize}
  }
  \addfield{Postcondiciones:}{
    El sistema se mantiene en el mismo estado.
  }
\end{usecase}

\subsection{Administrar plan de ahorro}

El plan de ahorro esta diseñado para ser la pagina principal del sistema
\texttt{PEAT} cuando el usuario ya creado por lo menos un perfil de edificio.

\begin{usecase}
  \addtitle{Caso de Uso:}{Administrar plan de ahorro}
  \addfield{Descripción:}{El sistema debe permitir la administración
    del plan de ahorro del edificio que consiste en un conjunto de recomendaciones
    que el usuario sea a comprometido a realizar o que ya ha completado
    para reducir su gasto energético.}
  \addfield{Actor:}{Usuario PyME}
  \additemizedfield{Precondiciones:}{
  \item El usuario a sido autentificado por medio de un token de autenticación
    (\textit{Single Sign On} SSO) asignado por el sistema de PG\&E.
  \item El usuario a creado previamente el perfil básico del edificio.
  }
  \addfield{Requerimientos no funcionales:}{
    Las actualizaciones a la pagina deben hacerse en forma asíncrona y sin necesitar
    una recarga completa de la pagina.
  }
  \addscenario{Flujo normal:}{
  \item El usuario no ha agregado ninguna recomendación a su plan
    \begin{enumerate}
    \item Las tres mejores recomendaciones son desplegadas dentro del marco
      del plan de ahorro
    \item El sistema elige estas recomendaciones por medio de la siguiente lógica:
      \begin{itemize}
      \item Son ordenadas según su periodo de recuperación (definido por el ahorro
        anual en dólares / costo en dólares por adelantado).
      \item Recomendaciones con costo inicial cero (por ejemplo, acciones basadas
        en comportamiento) se consideran que tienen un reembolso de dos años.
      \item Las recomendaciones que han sido marcadas como completadas o que no aplican
        no son parte de la selección para el plan de ahorro.
      \end{itemize}
    \end{enumerate}
  \item El usuario a agregado una o mas recomendaciones a su plan de ahorro.
    \begin{itemize}
    \item La mejor recomendación es desplegada debajo del componente PPW
    \item El sistema despliega una lista de las recomendaciones que el usuario
      a agregado a su plan.
      \begin{itemize}
      \item El sistema debe indicar que la lista de recomendaciones es el plan
        de ahorro.
      \item El usuario puede agregar mas recomendaciones desde la lista de
        recomendaciones, cuando se añade una recomendación esta solamente es
        visible en el plan de ahorro ya no debe de aparecer en la lista de
        recomendaciones
      \item El usuario puede remover recomendaciones de su plan seleccionando
        ''Remover del plan'' en un menú desplegable al lado del nombre de la
        acción.
      \end{itemize}
    \item El usuario puede ordenar la lista por nombre, categoría, costo, ahorro
      o reembolso.
    \item El usuario puede obtener mas información al dar click en el nombre
      de la recomendación.
    \item El usuario actualiza el estado de una recomendación a ''Completada''
      o ''Remover''.
      \begin{itemize}
      \item Las recomendaciones dentro del plan de ahorro solo pueden tener
        dos posibles estados: ''Completada'' y ''Remover'', el estado base
        de una recomendación agregada al plan es de ''Añadida''.
      \item Las recomendaciones con estado de ''Completada'' permanecen
        en el plan de ahorro con la selección ''Completada'' desplegada
        al lado del nombre de la acción.
      \end{itemize}
    \end{itemize}
  }
  \addfield{Postcondiciones:}{
    Si el usuario realizo cualquier acción en una recomendación entonces el plan
    de ahorro es actualizado y reordenado.
  }
\end{usecase}

\section{Interfaz de usuario}

Dados los requerimientos funcionales y no funcionales presentados en los
casos de uso se tiene que la interfaz de usuario debe tener las siguientes
características:

\begin{itemize}
\item La interfaz debe ser simple y enfocada a la información que el
  usuario necesita
\item La interfaz debe permitir realizar la mayoría de sus
  acciones de forma asincrónica, sin necesidad de una recarga completa de
  la pagina.
\item Toda interacción debe completarse en menos de un segundo.
\end{itemize}

Para cumplir estos requerimientos era necesario una cantidad considerable
de código Javascript en la parte del \textit{frontend}, para realizar peticiones
al servidor de forma asíncronas por medio de AJAX, y realizar las actualizaciones
a la vista después de recibir la respuesta del servidor.

Para permitir el reuso de código para la implementación de funcionalidad como
el componente de ingreso progreso era necesario escribir una cantidad de código
Javascript considerable, para dar estructura a estos componentes del
\textit{frontend} se eligió usar la biblioteca \textit{Backbone} puesto que permite
definir una arquitectura MVC, es decir permite definir modelos, vistas y
controladores en la parte del \textit{frontend}.

\subsection{Descripción general y navegación}

La interfaz de usuario en el sistema \texttt{PEAT} esta compuesta por ocho paginas
de las cuales tres son paginas de PG\&E y las restantes son gestionadas por
\texttt{PEAT}.

Toda las paginas del sistema muestran un menú de navegación que permite al
usuario navegar directamente a las paginas \textquote{Plan de ahorro},
\textquote{Recomendaciones} y \textquote{Perfil detallado del edificio}.

La descripción general de la paginas es el siguiente:

\begin{enumerate}
\item Un usuario entra al portal de PG\&E, luego a la pagina de ingreso del
  sistema \textit{MyEnergy} de PG\&E, en este sistema es donde los usuarios PyME
  hacen la administración de su perfil y cuentas con PG\&E. En el tablero de
  \textit{MyEnergy} se tiene una liga que invita al usuario a conocer sobre
  medidas para ahorrar, esta liga dirige al usuario al sistema \texttt{PEAT}
  (Ver Figura 3.3 1).
\item En el primer ingreso al sistema se dirige al usuario la pagina
  \textquote{Crear perfil del edificio} (Ver Figura 3.3 2), aquí el usuario
  solo contesta las preguntas básicas sobre su edificio
  (Ver caso de uso \textit{Crear perfil del edificio}).
  El usuario regresa a esta pagina cuando requiere agregar mas edificios a su cuenta.
  Al finalizar la creación del perfil se redirige al usuario a la pagina
  \textquote{Plan de ahorro}.
\item La pagina \textquote{Plan de ahorro} es la pagina principal del sistema
  \texttt{PEAT}, es decir es la pagina inicial cuando el usuario cuenta por lo
  menos con un un perfil de edificio al ingresar por medio de su tablero en
  \textit{MyEnergy} (Ver Figura 3.3 3).
  El plan de ahorro presenta la siguiente funcionalidad al usuario:
  \begin{itemize}
  \item Parte superior: se proporciona al usuario capacidad para interactuar
    con la facturación de sus gastos de energía por medio de gráficas comparativas
    (Ver caso de uso \textit{Ver historial de consumo}).
  \item Parte inferior: se muestra al usuario su plan de ahorro, es decir
    las recomendaciones que se ha comprometido a realizar para reducir su gasto
    (Ver caso de uso \textit{Administrar plan de ahorro}).
  \end{itemize}
  El usuario puede navegar a la pagina \textquote{Detalle de recomendación}
  de una recomendación mostrada en su plan de ahorro.
\item En la pagina \textquote{Recomendaciones} se tiene dos componentes
  (Ver Figura 3.3 4):
  \begin{itemize}
  \item El componente de ingreso progresivo que incita la usuario a
    dar mas información sobre su edificio (Ver caso de uso \textit{Obtener
      información del edificio}).
  \item Una lista de recomendaciones para reducir sus costos de energía
    basados en el perfil de su edificio (Ver caso de uso \textit{Administrar
      recomendaciones}).
  \end{itemize}
  El usuario puede navegar a la pagina \textquote{Detalle de recomendación}
  de las recomendaciones mostradas en la lista de recomendaciones.
\item La pagina \textquote{Perfil detallado del edificio} (Ver Figura 3.3 5) es
  donde el usuario puede responder o actualizar las respuestas a las preguntas
  sobre su edificio (Ver caso de uso \textit{Administrar perfil del edificio}).
\item La pagina \textquote{Detalle de recomendación} (Ver Figura 3.3 6) muestra los
  pormenores sobre las medidas que se necesitan realizar para lograr reducir
  el consumo en el edificio (Ver caso de uso \textit{Ver recomendación}).
\end{enumerate}

% FIXME: Remover pagina proxy del esquema de navegación.
\jcimageinline{1.0}{imagenes/UI-Navegacion.png}{Diagrama de alto nivel de
  la navegación en el sistema \texttt{PEAT}.}

\subsection{Diseño de página}

\subsubsection{Encabezado}

Todas las paginas del sistema \texttt{PEAT} comparten el mismo encabezado
el cual tiene las siguientes secciones (Ver Figura 3.4):

\begin{enumerate}[a)]
\item Componente de selección de edificios: este control muestra un menú
  desplegable con todos los edificios asociados al usuario.
\item Nombre del sistema: aunque el nombre interno del sistema es \texttt{PEAT}
  para el usuario el nombre del sistema es \textquote{Chequeo de energía del negocio}
  (\textit{Business Energy Checkup}).
\item Menú de navegación del sistema.
  \begin{itemize}
  \item Plan de ahorro (\textit{Energy Plan}): dirige al usuario a la pagina
    \textquote{Plan de ahorro}.
  \item Formas de ahorrar (\textit{Ways to Save}): dirige al usuario a la pagina
    \textquote{Recomendaciones}.
  \item Perfil de negocio (\textit{Business Profile}): dirige al usuario a la pagina
    \textquote{Perfil detallado del edificio}.
  \item Tomar un recorrido (\textit{Take a tour}): se muestra al usuario
    las diferentes paginas y secciones del sistema.
  \end{itemize}
\item Titulo de la pagina actual.
\item Componente de potencial de ahorro: este control muestra en todo momento
  el potencial de ahorro del edificio y el ahorro que se obtiene por el plan
  de ahorro del edificio.
\end{enumerate}

\jcimageinline{1.0}{imagenes/Disposicion-Encabezado.png}{Encabezado principal
  del sistema \texttt{PEAT}.}


\subsection{Crear perfil del edificio}

La pagina de \textquote{Crear perfil del edificio} es la pagina inicial
cuando el usuario no tiene ningún perfil de edificio asociado, esta pagina
también es usada cuando el usuario agrega mas edificios a su cuenta.

Esta pagina tuvo varias iteraciones por la retroalimentación obtenida por las
pruebas con usuarios, en las primeras iteraciones la pagina requería que el
usuario contestara toda la información requerida según el caso de de uso
\textit{Crear perfil del edificio}, esto representaba mucho trabajo al usuario
(Ver Figura 3.5).

\jcimageinline{0.75}{imagenes/SBP-Wireframe.png}{Versión inicial para crear
  un perfil de edificio.}

Para facilitar al usuario el ingreso de información se decidió implementar
las siguientes mejoras:

\begin{enumerate}
\item Se redujo el numero de opciones para el tipo de industria, inicialmente
  esta lista era numerosa lo que implicaba mas trabajo al usuario, se redujo
  a cinco opciones que son visibles inmediatamente.
\item Se dividió el ingreso de información en dos partes.
\end{enumerate}

En la versión final el sistema inicialmente pide al usuario seleccionar el tipo
de industria que mejor describe su negocio, las opciones son: comercial, industrial,
agricultura, agrícola, otro (Ver Figura 3.6).

\jcimageinline{0.75}{imagenes/SBP-Modal1.png}{Se pide al usuario
  el seleccionar el tipo de industria de su negocio.}

Después el sistema pide al usuario seleccionar su cuenta y dirección
de servicio, el alias del edificio, el tipo de edificio y su área
(Ver Figura 3.7).

\jcimageinline{0.75}{imagenes/SBP-Modal2.png}{Se pide al usuario ingresar
  las características básicas de su edificio.}

Al ingresar esta información el usuario es redirigido a la pagina
\textquote{Plan de ahorro} del perfil creado.

\subsection{Plan de ahorro}

La pagina \textquote{Plan de ahorro} es la pagina principal del sistema
\texttt{PEAT} dado que implementa la funcionalidad principal del sistema
que es la capacidad para interactuar con los datos sobre los gastos de
energía y la administración del plan de ahorro del edificio.

La pagina esta dividida en dos secciones principales, en la sección superior
se da el manejo de las gráficas para visualizar los gastos de energía y en la
sección inferior se tiene la administración del plan de ahorro.

\subsubsection{Visualización}

La sección superior consta de las siguientes partes:
\begin{itemize}
\item Menú de vistas: En este menú el usuario puede seleccionar
  que tipo de datos se despliega en las gráficas. Se tienen cuatro tipos
  de vista: gasto (\textit{Spending}), electricidad (\textit{Electricity}), gas
  (\textit{Gas}), emisiones de carbono (\textit{Carbon Emissions}) y análisis
  (\textit{Energy Use}). También en este menú en la parte derecha se
  tiene un estimado del ahorro que se puede obtener en el edificio
  si se implementan las recomendaciones (Ver Figura 3.8).
  \jcimage{1.0}{imagenes/Barra-Vistas-Ahorro.png}{Menú de vistas.}
\item Menú de rango de tiempo: Esta sección se encuentra enseguida del menú de
  vistas, aquí el usuario puede seleccionar entre los rangos de tiempo anual
  (\textit{Annually}), mensual (\textit{Monthly}) o diario (\textit{Daily}) de la
  vista seleccionada, en ciertas vistas se tienen opciones extra en la parte
  derecha como por ejemplo agregar datos de clima o de periodos anteriores
  a la vista actual (Ver Figura 3.9).
  \jcimage{1.0}{imagenes/Barra-Rango.png}{Menú de rango de tiempo.}
\item Área de visualización: En esta sección se despliega los datos de consumo
  del edificio mostrando los datos y rango de tiempo que el usuario ha seleccionado
  en los dos menús anteriores (Ver Figura 3.10).
  \jcimage{1.0}{imagenes/Grafica.png}{Visualización del gasto de electricidad.}
\end{itemize}

Para la implementación de las gráficas se utilizo el marco de trabajo
Ext JS, este marco de trabajo esta diseñado para implementar aplicaciones
de tipo \textit{SPA} por medio del lenguaje de programación Javascript.
Ext JS implementa un gran numero de controles de interfaz como como paneles,
barras de herramientas, deslizadores, etcétera.

Ext JS es una elección natural para el sistema \texttt{PEAT} dado que tiene un
excelente paquete de graficación el cual permite presentar visualmente una gran
cantidad de datos por medio de una amplia gama de gráficas: lineas, barras,
circulares, etcétera. Otro punto a favor de Ext JS es que el equipo de programadores
del \textit{frontend} estaba ampliamente familiarizado con este marco de trabajo.

Dada la capacidad de Ext JS para implementar interfaces se tenia el plan inicial
de implementar toda la interfaz con este marco de trabajo pero Ext JS tiene una
gran desventaja en que requiere de un tiempo de inicialización de sus componentes
demasiado grande, mas de un segundo, que va contrario a los requerimientos del
cliente.
Entonces se decidió hacer uso solamente del modulo de graficación de Ext JS y
hacer la implementación de los controles necesarios para la interfaz desde cero
haciendo uso de \texttt{Backbone}.

% TODO: Escribir un poco de Backbone y su papel en la interfaz

Para cada rango de tiempo se utiliza un tipo de gráfico y/o visualización diferente:

\begin{itemize}
\item Anual: se hace una comparativa entre el gasto del edificio en los últimos doce
  meses, el promedio de gasto de un edificio de características similares y
  el gasto de un edificio eficiente en su consumo energético. Para hacer estas
  comparaciones se utiliza gráficas de barras (Ver Figura 3.11).
  \jcimage{1.0}{imagenes/Vista-Anual.png}{Visualización anual del gasto de
    electricidad.}
\item Mensual: se muestra una gráfica de lineas del gasto del edificio
  en los últimos 12 meses, además permite comparar con el gasto del año anterior.
  Se puede agregar los datos sobre el clima durante el periodo que se esta
  visualizando (Ver Figura 3.12).
  \jcimage{0.9}{imagenes/Vista-Mensual.png}{Visualización mensual del gasto de
    electricidad.}
\item Diario: Se muestra una gráfica similar a la vista mensual pero en este caso
  se visualizan los últimos treinta días de gasto (Ver Figura 3.13)
  \jcimage{0.9}{imagenes/Vista-Diaria.png}{Visualización diaria del gasto de
    electricidad, con la comparativa al gasto del año pasado y datos del
    clima.}
\item Análisis: Se muestra un análisis del gasto del edificio en categorías
  por medio de una gráfica circular, este análisis es realizado usando
  aprendizaje de maquina por lo que este análisis es solo una estimación
  (ver Figura 3.14).
  \jcimage{0.9}{imagenes/Vista-Analisis.png}{Visualización del análisis del gasto de
    electricidad.}
\end{itemize}

Aunque las figuras solo muestran el caso del gasto en electricidad las
visualizaciones son idénticas para el gasto en gas.

\subsubsection{Administración}

La sección inferior consta de las siguientes partes (Ver Figura 3.15):
\begin{itemize}
\item Componente de ingreso progresivo: en este componente se despliega una pregunta
  sobre el edificio del usuario, las características de este componente
  se verán en detalle en la sección \ref{subsec:recomendaciones}.
\item Componente lista de recomendaciones: en este componente se despliega la
  lista de recomendaciones que forman el plan de ahorro del edificio,
  las características de este componente se verán a detalle en la sección
  \ref{subsec:componentes}.
  %  TODO: Reemplazar esta imagen por una de toda la sección inferior:
  \jcimage{0.9}{imagenes/Plan-Energia-Inicial.png}{Plan de energía inicial con
    recomendaciones.}
\end{itemize}

\subsection{Recomendaciones}
\label{subsec:recomendaciones}

La pagina \textquote{Recomendaciones} muestra al usuario una lista de
recomendaciones, es decir medidas que se pueden realizar en el edificio
para lograr disminuir el consumo energético del edificio. En esta lista se
tienen todas las recomendaciones aplicables que no están ya en el plan
de ahorro del edificio.

La pagina tiene dos secciones: la sección lateral contiene el componente de
ingreso progresivo y en la sección principal se tiene el componente lista
de recomendaciones.

\subsubsection{Componente lista de recomendaciones}

El componente lista de recomendaciones consta de las siguientes secciones:

\begin{itemize}
\item Encabezado: se muestran las características principales por las cuales
  el usuario puede ordenar la lista: nombre, categoría, costo, ahorro y recuperación
  de la inversión (Ver Figura 3.16).
  \jcimage{1.0}{imagenes/Recomendaciones-Encabezado.png}{Encabezado de la lista
    de recomendaciones.}
\item Renglón: por cada recomendación en la lista se despliegan las
  características principales definidas en el encabezado, además se tiene un botón
  que permite al usuario cambiar el estado de la recomendación.
  Para cada recomendación se tiene las siguientes secciones (Ver Figura 3.17):
  \begin{enumerate}[a)]
  \item Imagen representativa de la recomendación.
  \item Descripción de una linea de la recomendación.
  \item Categoría de la recomendación.
  \item Costo de implementar la recomendación.
  \item Ahorro que trae la recomendación en un año.
  \item Tiempo para recuperar la inversión, es decir cuanto tiempo el ahorro
    obtenido por implementar la recomendación es igual o superior al costo
    de su implementación.
  \item Breve descripción de las medidas necesarias para implementar la
    recomendación.
  \item Componente añadir al plan, este componente permite al usuario definir el
    estado de la recomendación, es decir si la recomendación es parte
    del plan de ahorro, ya fue implementada o no aplica al edificio.
  \end{enumerate}
  \jcimage{1.0}{imagenes/Recomendaciones-Renglon.png}{Las secciones de una
    recomendación.}
\end{itemize}

\subsubsection{Componente añadir al plan}

El componente añadir al plan permite al usuario cambiar el estado
de una recomendación, los estados posibles son:

\begin{itemize}
\item Por implementar: en este estado la recomendación no es parte
  del plan de ahorro del edificio. Este es el estado inicial de toda
  recomendación.
\item Añadido: este estado indica que el usuario a elegido implementar la
  recomendación y por lo tanto es parte del plan de ahorro del edificio.
\item No aplicable: este estado indica que la recomendación no es aplicable al
  edificio.
\item Completada: este estado indica que la recomendación ya fue implementada
  con éxito en el edificio, la recomendación se considera parte del
  plan de ahorro.
\end{itemize}

Mediante la interacción con este componente el usuario modifica el estado
de una recomendación. Este componente tiene el comportamiento de un botón y
de un menú despegable teniendo que presionar el componente realiza la
acción de agregar la recomendación al plan de ahorro, mientras mientras que
las demás acciones secundarias como remover del plan a la recomendación
son realizadas por medio del menú despegable.

Para realizar la transición del estado \textquote{Por implementar} al estado
\textquote{Añadido} el usuario solo tiene que presionar el control en su parte
izquierda (Ver Figuras \ref{fig:boton-inicial} y \ref{fig:boton-final}).
\rjcimage{0.4}{imagenes/Boton-Plan-Inicial.png}{Vista inicial del control
  de añadir al plan.}{boton-inicial}
\rjcimage{0.4}{imagenes/Boton-Plan-Anadido.png}{Vista cuando la recomendación
  a sido añadida al plan.}{boton-final}

El sistema despliega una ventana modal preguntando al usuario una estimación
del tiempo en que se podrá implementar las medidas propuestas por la
recomendación que se esta agregando al plan de ahorro (Ver Figura \ref{fig:estimacion-recomendacion}).
\rjcimage{0.5}{imagenes/Recomendaciones-Estimacion.png}{Al agregar una
  recomendación al plan el sistema pregunta el tiempo estimado para completar
  la recomendación.}{estimacion-recomendacion}

Para realizar otras acciones sobre la recomendación el usuario presiona la parte
derecha del componente en la parte que se tiene un triangulo que indica la
presencia de un menú despegable.
Estando la recomendación es un estado inicial \textquote{Por implementar} las
acciones en el menu despegable son para indicar que se ha completado la recomendación
(estado \textquote{Completada}) o que no es aplicable
(estado \textquote{No aplicable}) (Ver Figura \ref{fig:menu-anadir-inicial}).

\rjcimage{0.5}{imagenes/Boton-Plan-Menu-Inicial.png}{Las acciones de
  completar o indicar no aplicable en el menú despegable.}{menu-anadir-inicial}

Cuando la recomendación esta en el estado \textquote{Añadido} las
acciones en el menú despegable son las acciones de completar, remover o indicar
que no es aplicable la recomendación (Ver Figura \ref{fig:menu-anadir-anadido}).
\rjcimage{0.5}{imagenes/Boton-Plan-Menu-Anadido.png}{Las acciones de
  completar, remover o indicar no aplicable en el menú despegable.}{menu-anadir-anadido}

\subsection{Detalle de recomendación}

La pagina \textquote{Detalle de recomendación} es donde se tiene una descripción
detallada sobre la recomendación y las medidas que se tienen que implementar para
lograr reducir el consumo energético del edificio.

La pagina esta dividida en las siguientes secciones:
\begin{itemize}
\item Encabezado: se muestra una descripción breve de la recomendación y a su
  derecha se tiene el componente añadir al plan (Ver Figura
  \ref{fig:recomendacion-encabezado}).
  \rjcimage{1.0}{imagenes/Recomendacion-Titulo.png}{Encabezado de la recomendación
    para la instalación de un sistema de paneles solares.}{recomendacion-encabezado}
\item Descripción: se describe con detalle la información sobre las medidas
  necesarias para reducir el consumo energético del edificio.
  Dentro de la descripción se pueden tener una o varias preguntas al usuario
  de tal forma que se obtiene mas datos que permiten dar al usuario una mejor
  estimación sobre los costos y ahorro esperados al completar la recomendación.
  En la sección lateral se despliega el resultado del calculo estimado
  de costos y ahorro al completar la recomendación, estos datos son
  actualizados de forma asíncrona cuando el usuario contesta o cambia
  la respuesta a alguna de las preguntas presentadas en el contenido
  principal (Ver Figura \ref{fig:recomendacion-descripcion}).
  \rjcimage{1.0}{imagenes/Recomendacion-Descripcion.png}{Descripción detallada
    de la recomendación, con la estimación de costo y ahorro en la sección lateral.}{recomendacion-descripcion}
\end{itemize}

\subsection{Perfil detallado del edificio}

La pagina \textquote{Perfil detallado del edificio} es donde el usuario
ingresa o actualiza las características de su edificio por medio de un
conjunto de preguntas y respuestas divididas en categorías.

La pagina esta dividida en varias secciones, una sección por categoría:
\begin{itemize}
\item Edificio (\textit{Building})
\item Iluminación (\textit{Lightning})
\item Calefacción, ventilación y aire acondicionado (\textit{Heating, Ventilation and Air Conditioning} HVAC)
\item Refrigeración (\textit{Refrigeration})
\item Cocina (\textit{Cooking})
\item Calefacción de agua (\textit{Water-Heating})
\item Miscelánea (\textit{Misc})
\end{itemize}

Varias categorías como cocina y refrigeración solo son mostradas
para ciertos tipos de edificios (Ver Figura \ref{fig:perfil-categorias})

\rjcimage{1.0}{imagenes/Perfil-Secciones.png}{Las preguntas y respuestas sobre
  el edificio se organizan en categorías.}{perfil-categorias}

El usuario selecciona una categoría dando un click al titulo de una categoría,
entonces esa sección se abre para presentar las preguntas y respuestas
asociadas a esta.

Cada sección esta dividida en las siguientes partes (Ver Figura
\ref{fig:perfil-seccion}):
\begin{enumerate}
\item Encabezado de la sección: cada encabezado tiene un icono característico,
  el nombre de la categoría y en la parte derecha un marcador para indicar
  si todas las preguntas de la sección han sido respondidas por el usuario.
\item Preguntas y respuestas: las preguntas son breves y se refieren a una
  característica particular del edificio. La mayoría de las preguntas
  tiene respuestas definidas, teniendo solo un reducido numero de preguntas
  donde se espera el ingreso de un valor numérico. Las respuestas se
  presentan de las siguientes formas:
  \begin{enumerate}[a)]
  \item Menú desplegable: para preguntas que tienen mas de tres respuestas
    posibles excluyentes.
  \item Casillas de selección múltiple: para preguntas en que las respuestas
    pueden ser validas al mismo tiempo.
  \item Campo de texto limitado (solo un valor numérico): para las preguntas
    en que se necesita un valor numérico exacto.
  \item Botón de opción (con texto o imagen): para preguntas que tiene un
    numero limitado de respuesta posibles. Se hace uso de imágenes para las
    preguntas mas técnicas para facilitar al usuario el contestar la pregunta.
  \end{enumerate}
\item Botón siguiente: para progresar a la siguiente categoría.
\end{enumerate}

\rjcimage{1.0}{imagenes/Perfil-Preguntas.png}{Las preguntas de las secciones
  Edificio y HVAC.}{perfil-seccion}

\subsection{Componentes reusables}
\label{subsec:componentes}

En \texttt{PEAT} se tiene funcionalidad que se necesaria en varias paginas del
sistema, un ejemplo seria la necesidad de mostrar una pregunta sin contestar del
perfil del edificio.
Para permitir un mejor reuso de código y diseño se decidió implementar esta
funcionalidad en componentes independientes reusables que facilitaran su uso
en las diferentes paginas del sistema.

Los componentes que se implementaron son los siguientes:
\begin{itemize}
\item Componente de ingreso progresivo.
\item Componente del potencial de ahorro.
\item Componente lista de recomendaciones.
\item Componente añadir al plan.
\end{itemize}

% TODO: Mencionar que estos componentes además tienen que coordinarse
% al haber un cambio de estado, por medio de un canal de comunicación.

\subsubsection{Componente de ingreso progresivo}

Este componente muestra al usuario una pregunta y sus respuestas sobre el
perfil del edificio para motivar al usuario el proporcionar mas información
sobre su edificio. Este componente es usado en las paginas \textquote{Plan de ahorro}
y \textquote{Recomendaciones}.

El componente tiene las siguientes partes (Ver Figura \ref{fig:ingreso-progresivo}):
\begin{enumerate}[a)]
\item Pregunta y respuesta: se despliega una sola pregunta y
  las respuestas se presentan según los tipos de respuesta expuestos
  en el perfil del edifico.
\item Botón saltarse (\textit{Skip}): permite al usuario saltarse
  la pregunta mostrada y pasar a la siguiente pregunta sin contestar del perfil
  de su edificio.
\item Botón siguiente (\textit{Next}): permite al usuario el mandar
  su respuesta de la pregunta mostrada.
\item Link al perfil detallado: permite al usuario navegar al perfil
  detallado de su edificio.
\end{enumerate}
\rjcimage{0.5}{imagenes/PPW.png}{Componente de ingreso progresivo.}{ingreso-progresivo}

\subsubsection{Componente del potencial de ahorro}

Este componente permite al usuario saber el potencial de ahorro del edificio y su
ahorro esperado dado su plan de ahorro.

\subsubsection{Componente lista de recomendaciones}

Este componente lista las recomendaciones que se pueden realizar en un edificio para
reducir sus gastos energéticos, la descripción detallada de este componente esta en
la sección \ref{subsec:recomendaciones}.

\subsubsection{Componente añadir al plan}

Este componente permite modificar el estado de una recomendación,
la descripción detallada de este componente esta en la sección
\ref{subsec:recomendaciones}. Este componente es usado en las paginas
\textquote{Plan de ahorro}, \textquote{Recomendaciones} y
\textquote{Detalle recomendación}.

\section{Biblioteca Bezel}

Para realizar la integración entre el sistema \texttt{PEAT} y el servicio web C3,
el API proporcionado por el servidor C3, se implemento una biblioteca con el nombre
de \texttt{Bezel}.

\texttt{PEAT} hace uso del marco de trabajo Rails que a su vez hace
uso del patrón de arquitectura MVC. En Rails los modelos hacen uso de la
biblioteca \texttt{ActiveRecord} la cual permite implementar modelos basados
en tablas de bases de datos relacionales. En \texttt{PEAT} los datos
son proporcionados no directamente por una base de datos relacional sino por
el servicio web C3 proporcionado por el servidor C3.

Dentro del marco de trabajo Rails también se tiene la biblioteca
\texttt{ActiveResource} la cual implementa el caso de uso en que los datos son
proporcionados por un servicio web tipo RESTful. En un primer acercamiento se trato
de realizar la integración de \texttt{PEAT} con el servicio web C3 haciendo uso de
esta biblioteca pero se tenían las siguientes dificultades:

\begin{itemize}
\item Presupone que el servicio web hace uso de todos los métodos HTTP (GET, POST,
  UPDATE, DELETE) para definir las acciones básicas sobre un recurso.
\item No permite la definición de asociaciones entre recursos.
\end{itemize}

Aunque el servicio web C3 es de tipo RESTful este no hace uso de los métodos
HTTP para realizar acciones sobre los recursos del servicio, en el servicio web
C3 todas las acciones que se quieren realizar se realizan usando el método HTTP
POST y se manda la acción a realizar como un parámetro dentro de la petición HTTP.

La otra dificultad es que teníamos un gran numero de asociaciones entre los
recursos definidos por el servicio web C3 pero la biblioteca \texttt{ActiveResource}
no proporcionaba ninguna ayuda para implementar estas asociaciones.

Pero la biblioteca \texttt{ActiveResource} sirvió como inspiración para implementar
\texttt{Bezel} la cual no solamente proporciona acceso al servicio web C3 si no
que además permite reconstruir la estructura de tipos definida por el servidor C3
para el lenguaje de programación Ruby.

El servidor C3 cabe recordar esta implementado en dos lenguajes de programación, la
gran mayoría implementado con Javascript mientras que el núcleo y funciones criticas
están implementadas en Java. El servidor C3 puede mandar tanto XML como JSON como
respuesta a peticiones realizadas al servidor, pero la representación en JSON es la
mas usada dado que el sistema de tipos usando por el sistema esta definido en
Javascript.

\texttt{Bezel} permite la reconstrucción automática de los tipos definidos por el
servidor C3 en Javascript a modelos compatibles con el marco de trabajo Rails
y el lenguaje de programación Ruby. Esta reconstrucción automática permite
evitar desfases entre la definición de los tipos entre los dos sistemas y
agiliza el desarrollo del sistema \texttt{PEAT}.

Entonces \texttt{Bezel} define un lenguaje de dominio especifico para implementar
modelos basados en los tipos del servicio web C3, aprovechando que el servicio web
es tipo RESTful y las capacidades de metaprogramación de Ruby.

\texttt{Bezel} tiene dos modos principales de uso:
\begin{itemize}
\item Como un cliente REST con ciertas adecuaciones para una mejor
  integración con el API del servidor C3.
\item Como un lenguaje de dominio especifico interno para Ruby para la
  implementación automatizada de tipos y sus asociaciones del servicio web C3.
\end{itemize}

\subsection{Servicio web C3}

El servicio web C3 es de tipo RESTful es decir cada recurso o tipo tiene una única
dirección URL asociada. Las direcciones URL tienen la siguiente forma:

\vspace{2.5mm}
\texttt{POST} /api/$<$\textit{version}$>$/$<$\textit{tenant}$>$/$<$\textit{module}$>$;$<$\textit{tag}$>$/$<$\textit{type}$>$?action=$<$\textit{action-name}$>$

\begin{itemize}
\item \textit{version}: indica la versión del servicio a la cual se esta accediendo,
  el sistema \texttt{PEAT} hace uso de la versión 1.0.
\item \textit{tenant}: indica el producto o cliente, esto es porque cada
  producto y/o cliente cierta funcionalidad especifica. Para \texttt{PEAT} se tiene
  \textquote{peat} y \textquote{c3}.
\item \textit{module}: indica el modulo al que se esta accediendo, un conjunto
  de tipos se definen en un modulo en particular, para el sistema \texttt{PEAT} el
  modulo mas usado es el modulo \textquote{peat} pero también se hace uso
  de los módulos \textquote{billing} y \textquote{structure}.
\item \textit{tag}: indica el tipo de ambiente, es decir si el servicio web es para
  ambiente de pruebas, control de calidad, producción, etcétera.
  \textquote{peatprod} y \textquote{peatqa} son algunas de las \textit{tags}
  que se usaron para \texttt{PEAT}.
\item \textit{type}: indica el tipo al que se quiere acceder, \textquote{Building},
  \textquote{Location} y \textquote{BuildingEnergyConservationOption} son algunos
  de los tipos que se usaron para \texttt{PEAT}.
\item \textit{action-name}: indica la acción que se quiere realizar sobre
  el tipo indicado anteriormente. \textquote{fetch}, \textquote{upsert} y
  \textquote{remove} son unas de las acciones que se pueden realizar.
\end{itemize}

Como se comento anteriormente el servicio web C3 no es totalmente de tipo RESTful
principalmente porque se hace uso del mismo método HTTP POST para todas las acciones,
haciendo uso del \textquote{action-name} para ejecutar la acción correspondiente.
Para la implementación de \texttt{Bezel} solamente se espera que el servicio web
tenga direcciones únicas para cada tipo definido.

Muchas acciones aceptan parámetros los cuales son almacenados dentro del cuerpo
de la petición POST, por lo que el único parámetro que se manda por medio
de la URL es el nombre la acción a realizar.

\subsection{Arquitectura General}

La biblioteca \texttt{Bezel} esta conformada por un cinco clases y cinco módulos
siendo las clases principales \texttt{Bezel::Client} y \texttt{Bezel::Base}.

En el lenguaje de programación Ruby se tiene el concepto de módulo (\texttt{module}),
el cual no es mas que una agrupación de objetos bajo un único nombre. Los objetos
pueden ser constantes, métodos, clases y otros módulos.

Los módulos tienen dos usos: se pueden utilizar un modulo como una manera conveniente
de agrupar objetos o se puede incorporar los objetos del modulo a una clase haciendo
uso de \texttt{include} o \texttt{extend}.

\lstinputlisting[language=Ruby]{code/module-namespace.rb}

El ejemplo anterior muestra el uso de los módulos como un espacio de nombre,
en la linea 2 se define la constante \texttt{PI} y en las lineas 3 y 7 se definen
los métodos \texttt{sin} y \texttt{cos}, estos objetos son referenciados fuera del
modulo por medio del nombre del modulo como ocurre en la linea 12 en la cual se
hace referencia tanto a la constante y al método del modulo \texttt{Trig}.

\lstinputlisting[language=Ruby]{code/module-include.rb}

En este ejemplo se muestra el uso de los módulos para incorporar métodos de clase
o de instancia. En las lineas 1-11 se define el modulo \texttt{Boolean} el cual
define dos métodos \texttt{boolean?} y \texttt{to\_bool}, mientras en las lineas
13-17 se define el modulo \texttt{RandomString} que define un método \texttt{random}.
En las lineas 19-22 no se esta definiendo una nueva clase \texttt{String} si no
que Ruby permite modificar cualquier clase en tiempo de ejecución aunque esta
sea parte de la biblioteca estándar, así en la linea 20 se hace uso de la
declaración \texttt{include} la cual agregar los métodos del modulo dado
como métodos de instancia como se puede observar en las lineas 24-25.
Ahora en la linea 21 se hace uso de la declaración \texttt{extend} para agregar
los métodos del modulo dado como métodos de clase como se puede observar en
la linea 26.

Por lo anterior se tiene que el uso de módulos es una parte importante para
organizar y compartir funcionalidad en el lenguaje de programación Ruby.
Para la biblioteca \texttt{Bezel} tenemos el modulo \texttt{Bezel} que contiene
a todas las clases y módulos de la biblioteca.

Así se tiene que las clases y módulos que conforman la biblioteca son (Ver Figura \ref{fig:diagrama-clase}):
\begin{itemize}
\item \texttt{Bezel}: modulo principal que contiene a los demás submódulos y
  clases de la biblioteca.
\item \texttt{Bezel::Config}: modulo que define los métodos y valores validos
  para configurar el cliente con el servicio web C3.
\item \texttt{Bezel::Client}: clase que define un cliente para usar el servicio
  web C3.
\item \texttt{Bezel::Target}: clase que representa un tipo dado un contexto
  especifico (\textit{tenant}, \textit{tag}, \textit{module}).
\item \texttt{Bezel::Action}: clase que representa una acción sobre
  un tipo representado por un \texttt{Bezel::Target}.
\item \texttt{Bezel::Base}: clase abstracta que permite definir una clase de Ruby
  en base a un tipo del servido web C3.
\item \texttt{Bezel::Connections}: modulo que define las acciones básicas y de
  búsqueda sobre un tipo.
\item \texttt{Bezel::Cache}: clase que define un API para realizar operaciones
  de lectura/escritura sobre un cache.
\item \texttt{Bezel::CacheBase}: clase que redefine las acciones básicas y
  de búsqueda sobre un tipo haciendo uso de un cache \texttt{Bezel::Cache}.
\end{itemize}

\rjcimage{1.0}{imagenes/Diagrama-Clase-Bezel.png}{Diagrama de clase de la biblioteca
  Bezel}{diagrama-clase}

\subsubsection{Dependencias}

En la implementación de \texttt{Bezel} se hace uso de las siguiente bibliotecas
de apoyo:

\begin{itemize}
\item moneta: proporciona un API uniforme para realizar
  operaciones de lectura y escritura en un repositorio de cache.
\item faraday: proporciona un API uniforme para realizar
  peticiones HTTP.
\item hashie: proporciona un conjunto de metodos que extienden la funcionalidad
  de la clase \texttt{Hash} en Ruby.
\item activemodel: proporciona interfaces para modelos que deben operar sobre
  Rails.
\end{itemize}

\subsection{\texttt{Bezel}}

El modulo \texttt{Bezel} no solo sirve como el espacio de nombres principal para la
biblioteca si no que además implementa varios métodos auxiliares para facilitar la
configuración y creación de clientes para acceder al servicio web C3.

\lstinputlisting[language=Ruby]{code/bezel.rb}

En el código anterior se tiene la implementación abreviada de \texttt{Bezel},
en la linea 2 por medio de la declaración \texttt{extend} se añaden
varios métodos para configurar el cliente. En las lineas 4-30 se definen los
métodos auxiliares mas importantes:

\begin{itemize}
\item \texttt{new} (lineas 5-7): regresa una nueva instancia \texttt{Bezel::Client}.
\item \texttt{invoke} (lineas 9-11): realiza una petición al servicio web C3
  por medio del cliente asociado al modulo \texttt{Bezel}.
\item \texttt{client} (lineas 13-15): usando una variable de clase se inicializa o
  reusa una instancia \texttt{Bezel::Client}. Este método permite reutilizar un
  mismo cliente y conexión al servidor C3 evitando el costo de establecer un
  nuevo cliente y en establecer una conexión HTTP con el servidor.
\item \texttt{context} (lineas 17-29): permite cambiar el contexto de las
  peticiones que se realizan dentro de un bloque regresando al contexto original
  al finalizar el bloque por medio de una declaración \texttt{ensure}.
\end{itemize}

\lstinputlisting[language=Ruby]{code/config.rb}

En el modulo \texttt{Config} se definen dos constantes:
\begin{itemize}
\item \texttt{VALID\_OPTIONS\_KEYS} (lineas 4-13): un arreglo de símbolos que indica
  que atributos son validos.
\item \texttt{DEFAULT\_VALUES} (lineas 15-24): un hash donde se indican los valores
  por default de los atributos validos.
\end{itemize}

Haciendo uso del metodo \texttt{attr\_accessor} en la linea 26 se definen por cada
simbolo en \texttt{VALID\_OPTIONS\_KEYS} una atributo de instancia con sus
correspondientes métodos de acceso y escritura. El metodo \texttt{attr\_accessor} es
un ejemplo del uso de metaprogramacion en Ruby, dado que en base al simbolo dado
genera un atributo y sus metodos de acceso.

En la linea 30 se tiene el metodo \texttt{extended} el cual es un callback que es
llamado cuando un modulo es extendido, es decir es utilizado en una declaracion
\texttt{extend}. Para el modulo \texttt{Config} se tiene que cuando el modulo
es extendido, como es en el caso de \texttt{Config} dentro del modulo \texttt{Bezel}
llama el metodo \texttt{reset} para inicializar todos los attributos definidos en
el modulo con sus valores por default. El metodo \texttt{extended} es solo uno
de varios metodos callback que proporciona Ruby para la metaprogramacion.

Otro metodo muy importante para la metaprogramacion es \texttt{send} el cual es usado
en la linea 35 para inicializar los atributos definidos por \texttt{Config}, el
metodo \texttt{send} invoca el metodo identificado con el simbolo o cadena dada,
pasando los argumentos posteriores como argumento a la invocacion del metodo dado.

\subsection{\texttt{Bezel::Client}}

\lstinputlisting[language=Ruby]{code/client.rb}

\subsection{\texttt{Bezel::Base}}

\lstinputlisting[language=Ruby]{code/base-extend-include.rb}

\lstinputlisting[language=Ruby]{code/base-class-methods.rb}

\lstinputlisting[language=Ruby]{code/base-instance-methods.rb}

\subsubsection{\texttt{Bezel::Associations}}

\lstinputlisting[language=Ruby]{code/associations.rb}

\subsubsection{\texttt{Bezel::Connections}}

\lstinputlisting[language=Ruby]{code/connections.rb}

\subsubsection{\texttt{Bezel::CacheBase}}

\lstinputlisting[language=Ruby]{code/cache_base.rb}



