\chapter{Despliegue a producción y optimizaciones}

La etapa para desplegar una aplicación es una etapa de creciente importancia ya
que por un lado hace algunos años las aplicaciones web se desarrollaban bajo el
modelo de tres capas: la base de datos, el servidor de la aplicación y el servidor
web; actualmente se tienen mas servicios que deben estar en línea sobre todo para
garantizar un servicio concurrente; caches, equilibradores de carga, servidores
de cola, etcétera. Por lo que automatizar el despliegue de una aplicación en sus
diferentes contextos, desarrollo, producción y pruebas, es de vital importancia
para el desarrollo de software en tiempo y en forma.

\section{Despliegue continuo}

El despliegue continuo (\textit{Continuous Delivery}, CD) es una práctica de software
en la cual se implementa software de tal forma de que éste pueda ser desplegado a
producción en cualquier momento\cite{27_martin_fowler_cd}. Su objetivo es crear,
probar y liberar software más rápido y con mayor frecuencia.

\vspace{2.5mm}

Se considera que un sistema implementa el despliegue continuo cuando
\cite{27_martin_fowler_cd}:
\begin{itemize}
\item El sistema puede ser desplegado a producción en cualquier momento del
  ciclo de desarrollo.
\item Se tiene una rápida retroalimentación sobre la capacidad del sistema
  para ser desplegado en producción al realizarse cambios en el sistema.
\item Se puede desplegar de forma sencilla cualquier versión del software para
  cualquier entorno.
\end{itemize}

Los principales beneficios de esta práctica son:
\begin{itemize}
\item Reducción del riesgo de despliegue: dado que se realizan despliegues
  a producción de forma recurrente los cambios contenidos en cada despliegue
  son menores por lo que hay menores posibilidades de errores y si un error
  se presenta en mas fácil de localizar y arreglar.
\item Retroalimentación del usuario: uno de los mayores riesgos en la ingeniería
  del software es el desarrollar un sistema que no es útil para el cliente o usuario.
  Por lo tanto obtener retroalimentación sobre el desarrollo del sistema de forma
  rápida y frecuente permite evaluar que tan útil es el sistema para el usuario.
\end{itemize}

En \texttt{PEAT} los riesgos de lograr un despliegue a producción exitoso
eran más grandes de lo habitual dada la complejidad del sistema y la cantidad
de requerimientos. Además PG\&E requería el despliegue del sistema en ambientes
de pruebas previo a un despliegue del sistema en el ambiente de producción.
La implementación de un proceso de despliegue continuo para \texttt{PEAT} fue de
vital importancia para cumplir con las necesidades del cliente.

\vspace{2.5mm}

Para PG\&E era necesario que se tuvieran los siguientes ambientes:
\begin{itemize}
\item \textit{peattest}: este ambiente es usado para hacer pruebas con usuarios
  seleccionados por PG\&E para obtener retroalimentación sobre el sistema.
\item \textit{peatqa}: este ambiente es usado por PG\&E para realizar control de
  calidad y de rendimiento.
\item \textit{peatprod}: este ambiente es el ambiente final de producción.
\end{itemize}

Para uso interno en C3 Energy se tenia además el ambiente \textit{peatstage}
el cual era usado para realizar pruebas de rendimiento y de control de calidad.

En total se tenían cuatro ambientes, los cuales tenían que tener ser lo mas
parecidos en su configuración a la configuración del ambiente de producción
principalmente para que las pruebas de calidad y de rendimiento regresaran resultados
lo mas cercanos al comportamiento del sistema en el ambiente de producción.
Dados estos requerimientos la implementación del proceso de despliegue continuo para
el sistema \texttt{PEAT} era la mejor forma para manejar el despliegue del sistema
en esta diversidad de ambientes.

\subsection{Proceso de despliegue}

En el despliegue continuo se tiene al proceso de despliegue (\textit{deployment
  pipeline}) como concepto central, el cual en esencia es la implementación
automatizada de los procesos de configuración, construcción, prueba y despliegue de
un sistema \cite{28_humble_farley_2011}.

\vspace{2.5mm}

Este proceso tiene las siguientes ventajas:
\begin{itemize}
\item Visibilidad: todas las etapas del sistema de despliegue son visibles
  para todos los miembros del equipo.
\item Retroalimentación: los miembros del equipo obtiene información sobre los
  problemas en el momento en que ocurren de modo que son capaces de dar solución
  a éstos rápidamente.
\item Despliegue: por medio de un proceso totalmente automatizado se puede
  desplegar y liberar cualquier versión del sistema en cualquier ambiente y en
  cualquier momento.
\end{itemize}

El proceso de despliegue se conforma de una serie de etapas de validación por las
que el sistema debe pasar para llegar al ambiente de producción. Para el sistema
\texttt{PEAT} las etapas de validación son las siguientes (Ver Figura
\ref{fig:pipeline}):
\begin{itemize}
\item Control de versiones: El equipo de desarrollo ingresa los cambios
  realizados al sistema por medio del control de versiones Git, esto inicia
  el proceso de despliegue.
\item Pruebas de unidad: Al detectarse un cambio en el repositorio se corren
  pruebas las pruebas de unidad del sistema. Se usa la biblioteca \texttt{RSpec}
  para implementar las pruebas de unidad para el código en Ruby, mientras que para
  el código en Javascript se hace uso de la biblioteca \texttt{Jasmine} para las
  pruebas de unidad. El equipo de desarrollo recibe retroalimentación del resultado
  de las pruebas, si el resultado es positivo se pasa a la siguiente etapa.
  En la primera secuencia en la Figura \ref{fig:pipeline} se tiene el caso
  cuando las pruebas de unidad son negativas y se detiene el proceso de despliegue.
\item Pruebas de aceptación: Se hace uso de la biblioteca \texttt{Cucumber}
  para implementar las pruebas de aceptación, de la misma forma que la etapa de
  pruebas de unidad si se obtiene un resultado positivo se continua a la siguiente
  etapa en caso contrario se detiene el proceso de despliegue.
\item Ambientes de prueba: Se hace el despliegue del sistema en los ambientes de
  prueba, es decir, a los ambientes \textit{peatstage}, \textit{peattest} y
  \textit{peatqa}. En esta etapa se realizan pruebas de rendimiento y de calidad
  de forma manual y automatizada.
\item Producción: se hace un despliegue a producción cuando la versión en los
  sistemas de prueba han sido revisado de forma satisfactoria.
\end{itemize}

\rjcimage{1.0}{imagenes/Deployment-Pipeline.png}{Proceso de despliegue para
  \texttt{PEAT}.}{pipeline}

Las primeras etapas del proceso se desarrollan en forma completamente automatizada
hasta llegar a la etapa de despliegue a los ambientes de pruebas, en esta etapa
al principio se realizaban pruebas de calidad y rendimiento de forma manual, estas
actividades se fueron automatizando conforme fue pasando el tiempo haciendo uso de
herramientas como \texttt{SauceLabs} y \texttt{CloudTest}. La ejecución para
el despliegue al ambiente de producción se realiza de forma manual.

\subsubsection{Herramientas}

El proceso de despliegue se hace uso de un gran numero de herramientas, las más
importantes son:

\begin{itemize}
\item \texttt{AWS}: \textit{Amazon Web Services} (AWS), es un conjunto de servicios
  de computo en la nube que permite la implementación de sistemas escalables.
\item \texttt{Jenkins}: es un servidor de despliegue continuo, que permite
  definir las etapas de un proceso de despliegue y las acciones que se realizan
  según el resultado de la etapa.
\item \texttt{Capistrano}: es una herramienta que facilita la creación de tareas
  para el despliegue de sistemas en servidores remotos.
\item \texttt{CloudTest}: es una herramienta para la ejecución de pruebas de
  carga y rendimiento para aplicaciones móviles y web.
\item \texttt{SauceLabs}: es una herramienta que permite ejecutar las pruebas de un
  sistema en mas de 500 combinaciones de navegadores, sistema operativos
  y dispositivos.
\end{itemize}

\subsection{Configuración y despliegue automatizado de ambientes}

Para el despliegue de los ambientes requeridos para \texttt{PEAT} se hizo uso de
\textit{Amazon Web Services} (AWS) en particular del servicio
\textit{Amazon Elastic Compute Cloud} (EC2) que permite la renta de servidores
para correr aplicaciones.

El uso de \texttt{EC2} presentaba las siguientes ventajas:
\begin{itemize}
\item Una comunicación mas rápida y segura con \texttt{backend}, es decir, el
  servidor C3 dado que este corre bajo la servicio \texttt{EC2}.
\item El servicio \texttt{EC2} permite la configuración total de los servidores
  permitiendo automatizar la creación y configuración de éstos permitiendo
  que el sistema pueda escalar rápidamente según las necesidades de computo.
\end{itemize}

\subsubsection{Capistrano}

Para configurar los servidores del servicio \texttt{EC2} para \texttt{PEAT} se usa
\textit{Capistrano} que es una herramienta para definir y ejecutar tareas en
múltiples servidores remotos por medio de SSH. Esta herramienta define un DSL
basado en Ruby para la definición de tareas.

\textit{Capistrano} contiene tareas predefinidas para el despliegue de sistemas
basados en el marco de trabajo Rails, pero para el sistema \texttt{PEAT} se
implementaron tareas adicionales para realizar un despliegue exitoso.

\lstinputlisting[language=Ruby]{code/deploy-vars.rb}

El código anterior muestra la configuración base de variables para el
despliegue del sistema \texttt{PEAT} usando el DSL definido por \texttt{Capistrano}.
En las líneas 1-9 se definen las variables de configuración para el sistema
\texttt{PEAT} y el servidor Nginx, los valores por defecto están definidos
para un ambiente en producción, esto posteriormente facilita saber que diferencias
hay entre el ambiente en producción y los ambientes de pruebas.

En la linea 11 se definen los ambientes soportados, teniendo los cuatro
ambientes descritos anteriormente, cabe señalar que cada ambiente tiene
su propio archivo de configuración en donde se indican los cambios en variables
y/o tareas con respecto a la configuración base.

En las lineas 14-16 se configura que el sistema de versiones, la dirección
en donde se encuentra el repositorio y la rama que se usa para obtener el código
fuente del sistema. El sistema de versiones que se usa es Git donde la rama por
defecto es \textquote{release/v1.0} que es la rama estable del sistema que
se usa para producción, sin embargo es posible modificar la rama para permitir
el despliegue de cualquier versión/rama del sistema.

En las lineas 18-24 se tiene el uso de las declaraciones \texttt{after}
y \texttt{before} que permiten el establecer que una tarea sea realizada
antes o después de una segunda tarea. Cabe señalar que las tareas
\texttt{deploy:setup} y \texttt{deploy:restart} son tareas que son definidas
por \texttt{Capistrano}, la primera es una tarea para la configuración inicial
de un ambiente\footnote{Esta tarea es solo ejecutada una única vez para preparar
  un nuevo ambiente.} y la segunda tarea es realizada al reiniciar el sistema.

\lstinputlisting[language=Ruby]{code/deploy-tasks.rb}
