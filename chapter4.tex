\chapter{Despliegue a producción}

La etapa para desplegar una aplicación es una etapa de creciente importancia ya
que por un lado hace algunos años las aplicaciones web se desarrollaban bajo el
modelo de tres capas: la base de datos, el servidor de la aplicación y el servidor
web; actualmente se tienen mas servicios que deben estar en línea sobre todo para
garantizar un servicio concurrente; caches, equilibradores de carga, servidores
de cola, etcétera. Por lo que automatizar el despliegue de una aplicación en sus
diferentes contextos, desarrollo, producción y pruebas, es de vital importancia
para el desarrollo de software en tiempo y en forma.

\section{Despliegue continuo}

El despliegue continuo (\textit{Continuous Delivery}, CD) es una práctica de software
en la cual se implementa software de tal forma de que éste pueda ser desplegado a
producción en cualquier momento\cite{27_martin_fowler_cd}. Su objetivo es crear,
probar y liberar software más rápido y con mayor frecuencia.

\vspace{2.5mm}

Se considera que un sistema implementa el despliegue continuo cuando
\cite{27_martin_fowler_cd}:
\begin{itemize}
\item El sistema puede ser desplegado a producción en cualquier momento del
  ciclo de desarrollo.
\item Se tiene una rápida retroalimentación sobre la capacidad del sistema
  para ser desplegado en producción al realizarse cambios en el sistema.
\item Se puede desplegar de forma sencilla cualquier versión del software para
  cualquier entorno.
\end{itemize}

Los principales beneficios de esta práctica son:
\begin{itemize}
\item Reducción del riesgo de despliegue: dado que se realizan despliegues
  a producción de forma recurrente los cambios contenidos en cada despliegue
  son menores por lo que hay menores posibilidades de errores y si un error
  se presenta en mas fácil de localizar y arreglar.
\item Retroalimentación del usuario: uno de los mayores riesgos en la ingeniería
  del software es el desarrollar un sistema que no es útil para el cliente o usuario.
  Por lo tanto obtener retroalimentación sobre el desarrollo del sistema de forma
  rápida y frecuente permite evaluar que tan útil es el sistema para el usuario.
\end{itemize}

En \texttt{PEAT} los riesgos de lograr un despliegue a producción exitoso
eran mas grande de lo habitual dada la complejidad del sistema y la cantidad
de requerimientos. Además PG\&E requería la implementación de varios ambientes
previos al despliegue del sistema en el ambiente de producción, entonces
el implementar el proceso de despliegue continuo para \texttt{PEAT} fue de vital
importancia para cumplir con las necesidades del cliente.

\vspace{2.5mm}

Para PG\&E era necesario que se tuvieran los siguientes ambientes:
\begin{itemize}
\item \textit{peattest}: este ambiente es para un grupo de usuarios seleccionados
  por PG\&E para obtener retroalimentación sobre el sistema.
\item \textit{peatqa}: este ambiente es para un equipo de PG\&E para realizar
  control de calidad y de rendimiento.
\item \textit{peatprod}: este ambiente es el ambiente final de producción.
\end{itemize}

Para uso interno en C3 Energy se tenia además el ambiente \textit{peatstage}
el cual era usado para realizar pruebas de rendimiento y de control de calidad.

En total se tenían cuatro ambientes, los cuales tenían que tener que ser lo mas
parecidos a la configuración final del ambiente de producción para que las pruebas
de calidad y de rendimiento generaran información que fuera lo mas cercano al
comportamiento del sistema en el ambiente de producción. Dados estos requerimientos
la implementación del proceso de despliegue continuo para el sistema \texttt{PEAT}
fue una decisión casi natural para permitir manejar el despliegue del sistema para
cualquier combinación de versión-ambiente requerido.

\subsection{Proceso de despliegue}

En el despliegue continuo se tiene al proceso de despliegue (\textit{deployment
  pipeline}) como concepto central, el cual en esencia es la implementación
automatizada de los procesos de configuración, construcción, prueba y despliegue de
un sistema \cite{28_humble_farley_2011}.

\vspace{2.5mm}

Este proceso otorgar las siguientes ventajas:
\begin{itemize}
\item Visibilidad: todas las etapas del sistema de despliegue son visibles
  para todos los miembros del equipo.
\item Retroalimentación: Los miembros del equipo obtiene información sobre los
  problemas cuando se producen de modo que son capaces de solucionarlos lo mas
  rápido posible.
\item Despliegue: por medio de un proceso totalmente automatizado se puede
  desplegar y liberar cualquier versión del sistema en cualquier ambiente.
\end{itemize}

El proceso de despliegue se conforma de una serie de etapas de validación por las
que el sistema debe pasar para llegar al ambiente de producción. Para el sistema
\texttt{PEAT} las etapas de validación son las siguientes (Ver Figura
\ref{fig:pipeline}):
\begin{itemize}
\item Control de versiones: El equipo de desarrollo ingresa los cambios
  realizados al sistema por medio del control de versiones Git, esto inicia
  el proceso de despliegue.
\item Pruebas de unidad: Al detectarse un cambio en el repositorio se corren
  pruebas las pruebas de unidad del sistema. Se usa la biblioteca \texttt{RSpec}
  para implementar las pruebas de unidad para el código en Ruby, mientras que se
  usa la biblioteca \texttt{Jasmine} para las pruebas de unidad para el código en
  Javascript. El equipo de desarrollo recibe retroalimentación del resultado de
  las pruebas, si el resultado es positivo se pasa a la siguiente etapa.
  En la primera secuencia en la Figura \ref{fig:pipeline} se tiene el caso
  cuando las pruebas de unidad son negativas y se detiene el proceso de despliegue.
\item Pruebas de aceptación: Se hace uso de la biblioteca \texttt{Cucumber}
  para implementar las pruebas de aceptación, de la misma forma que las pruebas
  de unidad si se tiene un resultado positivo se continua a la siguiente etapa en
  caso contrario se detiene el proceso de despliegue.
\item Ambientes de prueba: Se hace el despliegue del sistema en los ambientes de
  prueba, es decir, a los ambientes \textit{peatstage}, \textit{peattest} y
  \textit{peatqa}. En esta etapa se realizan pruebas de rendimiento y de prueba
  de calidad de forma manual.
\item Producción: se hace un despliegue a producción cuando la versión en los
  sistemas de prueba han sido revisados de forma satisfactoria.
\end{itemize}

\rjcimage{1.0}{imagenes/Deployment-Pipeline.png}{Proceso de despliegue para
  \texttt{PEAT}.}{pipeline}

Las primeras etapas del proceso se desarrollan en forma completamente automatizada
hasta llegar a la etapa de despliegue a los ambientes de pruebas, en esta etapa
al principio se realizaban pruebas de calidad y rendimiento de forma manual, estas
actividades se fueron automatizando conforme fue pasando el tiempo haciendo uso de
herramientas como \texttt{SauceLabs} y \texttt{CloudTest}. La ejecución para
el despliegue al ambiente de producción se realiza de forma manual.

\subsubsection{Herramientas}

Para lograr la automatización del proceso de despliegue se hace uso de una conjunto
de herramientas las cuales son:

\begin{itemize}
\item \texttt{Jenkins}: es un servidor de despliegue continuo, que permite
  definir las etapas de un proceso de despliegue y las acciones que se realizan
  según el resultado de la etapa.
\item \texttt{Capistrano}: es una herramienta para correr programas para el
  despliegue de sistemas.
\end{itemize}

%% La integración continua es una practica de software en la cual los integrantes
%% de un proyecto integran su trabajo (código, diseño, etcétera) de forma frecuente
%% realizando un despliegue al ambiente de producción al menos una vez al día
%% \cite{26_martin_fowler_ci}. Esta practica busca reducir de forma significativa los
%% problemas de integración, los cuales se incrementan en sistemas de gran tamaño
%% que tienen varios módulos que interactúan entre si.

%% Cada integración es verificada por medio de un constructor automatizado, el cual
%% hace uso de las pruebas del sistema\footnote{Pruebas de unidad, funcional e
%%   integración} para detectar errores de integración lo más rápido posible.
